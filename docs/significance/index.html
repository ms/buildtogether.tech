<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<script defer data-domain="buildtogether.tech" src="https://plausible.io/js/plausible.js"></script>
<link rel="icon" type="image/x-icon" href="../files/favicon.ico">
<link rel="stylesheet" href="../mccole.css">
<link rel="stylesheet" href="../codehilite-tango.css">

    <title>Building Software Together: Signifcance Testing</title>
  </head>
  <body class="page">
    <div class="centered title">
      
      <h2><a href="../">Building Software Together</a></h2>
      <h1>Chapter 6: Signifcance Testing</h1>
      
      <p>
        <img class="page-logo" src="../codebender.svg" alt="logo" />
      </p>
    </div>

<ul>
<li>Problem: how to estimate development effort or likely fault rates<ul>
<li>Intuitively seems like this should depend on some measurable properties of the software</li>
<li>Lines of code (LoC) is easy to count but seems like a pretty coarse measure</li>
<li>How can we count other things?</li>
<li>How can we tell whether a hypothesis is true or not?</li>
</ul>
</li>
<li>Steps are:<ul>
<li>Collect data</li>
<li>Formulate testable hypotheses</li>
<li>Calculate likelihood of getting the answer we observe</li>
<li>Decide whether that answer is so unlikely that we probably didn't get it by chance</li>
</ul>
</li>
</ul>
<h2>How can we get data on file sizes?</h2>
<ul>
<li>Start by asking whether Python and JavaScript files are different,
    i.e., how our measurements depend on source language</li>
<li>Parsing arguments and writing CSV is normal by now</li>
<li>Use <code>os.walk</code> to recurse through directories</li>
<li>After the first failure because of bad <a class="glossref" href="../glossary/#character_encoding" markdown="1">character encoding</a>, add error handling</li>
<li>Then capture <code>stderr</code> to a log file for later inspection</li>
<li>Then realize that storing (filename, length, count):<ol>
<li>Is too big for GitHub unless we compress it</li>
<li>Contains a lot of redundancy</li>
</ol>
</li>
<li>Instead of compressing the file, create two files:<ul>
<li>One stores (filename, unique ID)</li>
<li>The other stores (unique ID, length, count)</li>
<li>So the largest field (filename) only appears once</li>
<li>And gives us a natural way to record files we couldn't read because of character encoding issues (<code>NA</code> for file ID)</li>
</ul>
</li>
<li>
<p>This technique is also useful when storing <a class="glossref" href="../glossary/#pid" markdown="1">personal identifying information</a> (PID)</p>
<ul>
<li>Shareable data is keyed</li>
<li>Personal data is not shared</li>
<li>Beware of <a class="glossref" href="../glossary/#de_anonymization" markdown="1">de-anonymization</a></li>
</ul>
</li>
<li>
<p>Main driver is straightforward</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Main driver.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">report_filenames</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">counts</span><span class="p">)</span>
    <span class="n">report_counts</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">counts</span><span class="p">)</span>
</code></pre></div>

<ul>
<li>Parse arguments<ul>
<li>Root directory</li>
<li>Filename extension</li>
<li>Stem of output files (because there are two)</li>
<li>E.g., processing <code>data/python</code> will produce <code>data/python-filenames.csv</code> and <code>data/python-counts.csv</code></li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Handle command-line arguments.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--root&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;root directory&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ext&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;extension&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;stem of output files&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</code></pre></div>

<ul>
<li>Find files and record lengths<ul>
<li>A dictionary mapping filenames to <code>Counter</code> objects</li>
<li>Or to <code>None</code> if the file couldn't be read</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">lengths</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Find files and count line lengths.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">curr_dir</span><span class="p">,</span> <span class="n">sub_dirs</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">root</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ext</span><span class="p">)]:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curr_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">counts</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">reader</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                        <span class="n">counts</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                     <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to read </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                           <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                     <span class="n">counts</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">counts</span>
</code></pre></div>

<ul>
<li>Write the filenames or <code>NA</code><ul>
<li>Uses <code>X if test else Y</code>, which is frequently confusing</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">report_filenames</span><span class="p">(</span><span class="n">output_stem</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Report filename-to-ID as CSV with &#39;NA&#39; for errored files.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_stem</span><span class="si">}</span><span class="s1">-filenames.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">lineterminator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Filename&#39;</span><span class="p">,</span> <span class="s1">&#39;FileID&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">file_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">filename</span><span class="p">,</span> <span class="n">file_id</span> <span class="k">if</span> <span class="n">counts</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;NA&#39;</span><span class="p">])</span>
</code></pre></div>

<ul>
<li>And the counts where available</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">report_counts</span><span class="p">(</span><span class="n">output_stem</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Report file ID-to-count as CSV for non-errored files.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_stem</span><span class="si">}</span><span class="s1">-counts.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">lineterminator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;FileID&#39;</span><span class="p">,</span> <span class="s1">&#39;Length&#39;</span><span class="p">,</span> <span class="s1">&#39;Count&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">file_id</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">if</span> <span class="n">counts</span><span class="p">[</span><span class="n">filename</span><span class="p">]:</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span><span class="o">.</span><span class="n">most_common</span><span class="p">():</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">file_id</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">freq</span><span class="p">])</span>
</code></pre></div>

<ul>
<li><code>python bin/file-size.py --root /anaconda3 --ext .py --output data/python</code></li>
<li>Get some errors<ul>
<li>Store in <code>log/file-size-python-errors.txt</code> for later reference</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code>Failed to read /anaconda3/pkgs/xlwt-1.3.0-py37_0/lib/python3.7/site-packages/xlwt/BIFFRecords.py: &#39;utf-8&#39; codec can&#39;t decode byte 0x93 in position 68384: invalid start byte
Failed to read /anaconda3/pkgs/xlwt-1.3.0-py37_0/lib/python3.7/site-packages/xlwt/UnicodeUtils.py: &#39;utf-8&#39; codec can&#39;t decode byte 0xb7 in position 1950: invalid start byte
Failed to read /anaconda3/pkgs/pylint-2.3.1-py37_0/lib/python3.7/site-packages/pylint/test/functional/implicit_str_concat_in_sequence_latin1.py: &#39;utf-8&#39; codec can&#39;t decode byte 0xe9 in position 96: invalid continuation byte
Failed to read /anaconda3/pkgs/joblib-0.13.2-py37_0/lib/python3.7/site-packages/joblib/test/test_func_inspect_special_encoding.py: &#39;utf-8&#39; codec can&#39;t decode byte 0xa4 in position 64: invalid start byte
...
</code></pre></div>

<ul>
<li>Also run <code>python bin/file-sizes.py ~/blocks/node_modules</code><ul>
<li><code>blocks</code> is a JavaScript project we just have to have lying around</li>
<li><code>node_modules</code> is where the project's JavaScript packages are stored</li>
</ul>
</li>
<li>Create scatter plots of to show frequency of line lengths</li>
<li>Add a <a class="glossref" href="../glossary/#pattern_rule" markdown="1">pattern rule</a> to <code>Snakefile</code><ul>
<li>Assign the languages and kinds of figures to variables</li>
<li>Fill in all combinations of those variables with <code>expand</code></li>
<li>Create a target called <code>all</code> that depends on the expanded list of files</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">LANGS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;javascript&#39;</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="p">]</span>
<span class="n">KINDS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;trimmed&#39;</span><span class="p">]</span>

<span class="n">rule</span> <span class="nb">all</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="n">expand</span><span class="p">(</span><span class="s1">&#39;figures/</span><span class="si">{lang}</span><span class="s1">-counts-</span><span class="si">{kind}</span><span class="s1">.svg&#39;</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">LANGS</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">KINDS</span><span class="p">)</span>

<span class="n">rule</span> <span class="n">count_all</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="s1">&#39;data/</span><span class="si">{lang}</span><span class="s1">-counts.csv&#39;</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="s1">&#39;figures/</span><span class="si">{lang}</span><span class="s1">-counts-all.svg&#39;</span>
    <span class="n">shell</span><span class="p">:</span>
        <span class="s1">&#39;python bin/length-frequency-plot.py --data </span><span class="si">{input}</span><span class="s1"> --fig </span><span class="si">{output}</span><span class="s1"> --logx&#39;</span>

<span class="n">rule</span> <span class="n">count_trimmed</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="s1">&#39;data/</span><span class="si">{lang}</span><span class="s1">-counts.csv&#39;</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="s1">&#39;figures/</span><span class="si">{lang}</span><span class="s1">-counts-trimmed.svg&#39;</span>
    <span class="n">shell</span><span class="p">:</span>
        <span class="s1">&#39;python bin/length-frequency-plot.py --data </span><span class="si">{input}</span><span class="s1"> --fig </span><span class="si">{output}</span><span class="s1"> --low 2 --high 200&#39;</span>
</code></pre></div>

<ul>
<li>Create log-log histograms for frequency of line lengths
    in JavaScript <span f="javascript-counts-all"/>
    and Python <span f="python-counts-all"/></li>
</ul>
<figure id="javascript-counts-all">
  <img src="./figures/javascript-counts-all.svg" alt="Log-log scatter plot with a point at Y equals 200,000 and X equals 1 and then a noticeable decline for X above 80." />
  <figcaption markdown="1">Figure 6.1: Frequency of Line Lengths (JavaScript, All)</figcaption>
</figure>

<figure id="python-counts-all">
  <img src="./figures/python-counts-all.svg" alt="Log-log scatter plot with a point at Y equals 2,000,000 at X equals 1 and then a sharp decline for X above 80." />
  <figcaption markdown="1">Figure 6.2: Frequency of Line Lengths (Python, All)</figcaption>
</figure>

<ul>
<li>Exclude lines of length 1<ul>
<li>These only contain the newline character, i.e., they're empty</li>
</ul>
</li>
<li>Exclude lines longer than 200 characters<ul>
<li>Possibly a character encoding issue</li>
<li>Or <a class="glossref" href="../glossary/#minification" markdown="1">minification</a> of JavaScript</li>
</ul>
</li>
</ul>
<figure id="javascript-counts-trimmed">
  <img src="./figures/javascript-counts-trimmed.svg" alt="Log-linear plot showing Y approximately 20,000 for X up to 50 and steady decline thereafter." />
  <figcaption markdown="1">Figure 6.3: Frequency of Line Lengths (JavaScript, Trimmed)</figcaption>
</figure>

<figure id="python-counts-trimmed">
  <img src="./figures/python-counts-trimmed.svg" alt="Log-linear plot showing Y approximately 20,000 for X below 10, Y between 100,000 and 200,000 for X up to 80, and a very sharp decline thereafter." />
  <figcaption markdown="1">Figure 6.4: Frequency of Line Lengths (Python, Trimmed)</figcaption>
</figure>

<ul>
<li>These curves look different, but are they?</li>
</ul>
<h2>How can we tell if two populations are different?</h2>
<ul>
<li><a class="glossref" href="../glossary/#null_hypothesis" markdown="1">Null hypothesis</a>: there is no significant difference between these curves</li>
<li><a class="glossref" href="../glossary/#alternative_hypothesis" markdown="1">Alternative hypothesis</a>: there is a significant difference between these curves</li>
<li>Reject the null hypothesis if the probability of getting this data <em>if the null hypothesis is true</em>
    is less than a chosen probability called a <a class="glossref" href="../glossary/#p_value" markdown="1"><em>p</em> value</a><ul>
<li>Typically use \( p = 0.05 \), i.e., less than 1 chance in 20 of getting the data if there isn't actually a difference</li>
<li>The lower the <em>p</em> value, the higher our confidence</li>
</ul>
</li>
</ul>
<div class="callout">
<h3>Kick the ball then move goal</h3>
<p><em>p</em> values can be mis-used in several ways.
The most obvious is to choose a <em>p</em> value after the fact in order to get a significant result:
if you ever see reports that mix several different <em>p</em> values or use odd numbers like 0.073,
this is probably what's going on.</p>
<p>The second form of abuse, called <a class="glossref" href="../glossary/#p_hacking" markdown="1"><em>p</em> hacking</a>,
is to re-analyze the data over and over until a "significant" result emerges.
Consider: if the odds of getting a false positive for one analysis are 0.05,
then the odds of getting a true negative are 0.95.
The odds of getting two true negatives in a row are therefore \( 0.95^2 \),
which is 0.9025.
If we keep going, the odds of none of our analyses meeting this threshold are 50/50
when we do 14 analyses.
One sign that people are <em>p</em> hacking is that they find niche results like,
"This treatment was effective for left-handed non-smokers between the ages of 45 and 55."
The best way to safeguard against <em>p</em> hacking is to <a class="glossref" href="../glossary/#pre_registration" markdown="1">pre-register</a> studies,
i.e.,
to declare before collecting data what analyses are going to be done and how.</p>
</div>
<ul>
<li>But how do we measure the likelihood?</li>
<li>One approach is to use simulation<ul>
<li>Combine data sets</li>
<li>Split into two pieces at random (where each piece is the same size as one of the originals)</li>
<li>See how far apart the means are</li>
<li>Repeat a few thousand times</li>
<li>See how often we get the difference we actually see</li>
<li>Decide if we believe the difference is likely</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="c1"># !/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Sample two datasets to calculate odds of means being distant.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># ...parse arguments...</span>
    <span class="c1"># ...read data and calculate actual means and difference...</span>
    <span class="c1"># ...repeatedly sample and calculate difference...</span>
    <span class="c1"># ...report...</span>
</code></pre></div>

<ul>
<li>Arguments are pretty simple<ul>
<li>Two files</li>
<li>Cut the low and high values as we did for plotting</li>
<li>Number of trials</li>
<li><a class="glossref" href="../glossary/#rng_seed" markdown="1">Seed</a> for <a class="glossref" href="../glossary/#rng" markdown="1">random number generator</a> so we can reproduce results</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># parse arguments</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--left&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;first dataset&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--right&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;second dataset&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--low&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;lower limit&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--high&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;upper limit&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--trials&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of trials (&gt;0)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--seed&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;RNG seed&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
</code></pre></div>

<ul>
<li>Read the data and calculate actual statistics</li>
</ul>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># read data and calculate actual means and difference</span>
    <span class="n">data_left</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">high</span><span class="p">)</span>
    <span class="n">data_right</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">high</span><span class="p">)</span>
    <span class="n">mean_left</span> <span class="o">=</span> <span class="n">data_left</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">mean_right</span> <span class="o">=</span> <span class="n">data_right</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">actual_diff</span> <span class="o">=</span> <span class="n">mean_left</span> <span class="o">-</span> <span class="n">mean_right</span>
</code></pre></div>

<ul>
<li>And:</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read data and remove lines of length 1 and very long lines.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="n">high</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">low</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Length</span> <span class="o">&gt;=</span> <span class="n">low</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">Length</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeats</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">Count</span><span class="p">)</span>
</code></pre></div>

<ul>
<li>For each simulation:<ul>
<li>Shuffle the index</li>
<li>Cut the data in two</li>
<li>Calculate means for the sections</li>
<li>Record difference in the means</li>
</ul>
</li>
<li>Afterward:<ul>
<li>Calculate the fraction of differences that are less than or equal to the actual difference</li>
<li>For comparison, also report the average difference in the means</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># repeatedly sample and calculate difference</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">data_left</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_right</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">split</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_left</span><span class="p">)</span>
    <span class="n">sample_diffs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trials</span><span class="p">):</span>
        <span class="n">shuffle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combined</span><span class="p">))</span>
        <span class="n">sample_left</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="n">shuffle</span><span class="p">[:</span><span class="n">split</span><span class="p">]]</span>
        <span class="n">sample_right</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="n">shuffle</span><span class="p">[</span><span class="n">split</span><span class="p">:]]</span>
        <span class="n">sample_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample_left</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">sample_right</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

    <span class="n">sample_diff_mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sample_diffs</span><span class="p">)</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">trials</span>
    <span class="n">success_frac</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">actual_diff</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sample_diffs</span><span class="p">])</span> <span class="o">/</span> <span class="n">args</span><span class="o">.</span><span class="n">trials</span>
</code></pre></div>

<ul>
<li>Write results as <a class="glossref" href="../glossary/#yaml" markdown="1">YAML</a><ul>
<li>A long two-column CSV with (title, value) pairs would work</li>
<li>As would a wide CSV with one row of titles and one row of values</li>
<li>Either way, must write parameter values to ensure reproducibility</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># report</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;parameters:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- left: &quot;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">left</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- right: &quot;</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">right</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- low: </span><span class="si">{</span><span class="s2">&quot;null&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">low</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">low</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- high: </span><span class="si">{</span><span class="s2">&quot;null&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">high</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">high</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- trials: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">trials</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- seed: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;results:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- mean_left: </span><span class="si">{</span><span class="n">mean_left</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- mean_right: </span><span class="si">{</span><span class="n">mean_right</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- actual_diff: </span><span class="si">{</span><span class="n">actual_diff</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- sample_diff: </span><span class="si">{</span><span class="n">sample_diff_mean</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- successes: </span><span class="si">{</span><span class="n">success_frac</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>

<h2>How can we test our approach?</h2>
<ul>
<li>We're showing completed working code, but we didn't get it right the first time</li>
<li>Create two "populations" and see if we get a plausible answer<ul>
<li><code>[1, 1]</code> vs. <code>[10, 10]</code></li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code>python bin/simulate.py --left test/test-a.csv --right test/test-b.csv --trials <span class="m">10000</span> --seed <span class="m">1234567</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>parameters:
- left: &quot;test/test-a.csv&quot;
- right: &quot;test/test-b.csv&quot;
- low: null
- high: null
- trials: 10000
- seed: 1234567
results:
- mean_left: 1.0
- mean_right: 10.0
- actual_diff: -9.0
- sample_diff: -0.0126
- successes: 0.1661
</code></pre></div>

<ul>
<li>Is that right?<ul>
<li>8/24 permutations of the four values are a "perfect split"</li>
<li>But only half of those have the low values in the lower half</li>
<li>So we expect 4/24 successes, which is 0.1666... and we actually got 0.1661</li>
<li>Our simulation reports that the expected difference is 0.0 and the simulated difference is -0.0126</li>
<li>Seems to be doing what we want</li>
</ul>
</li>
<li>We should test with unequal counts and numbers of samples<ul>
<li>Left as an exercise</li>
</ul>
</li>
<li>And note that this doesn't test if the means are <em>different</em>, only if the first is less than the second<ul>
<li>A <a class="glossref" href="../glossary/#one_sided_test" markdown="1">one-sided test</a></li>
<li>If this says "yes" and we reverse the order of the datasets, the answer will be "no"</li>
<li>Convert this into a <a class="glossref" href="../glossary/#two_sided_test" markdown="1">two-sided test</a> in the exercises</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code>python bin/simulate.py --left data/javascript-counts.csv --right data/python-counts.csv --trials <span class="m">5000</span> --seed <span class="m">57622</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>parameters:
- left: &quot;data/javascript-counts.csv&quot;
- right: &quot;data/python-counts.csv&quot;
- low: null
- high: null
- trials: 5000
- seed: 57622
results:
- mean_left: 38.168300030969725
- mean_right: 36.41329390723824
- actual_diff: 1.7550061237314836
- sample_diff: 0.00398256511711528
- successes: 1.0
</code></pre></div>

<ul>
<li>None of the 5000 random trials had a difference as big as what we actually see</li>
<li>So it seems pretty certain that the difference is more than just chance</li>
<li>But it takes about two hours to run 5000 simulations on our real data<ul>
<li>We should add a <code>--verbose</code> flag to report progress</li>
<li>Or print the stats every N iterations so we can check <a class="glossref" href="../glossary/#convergence" markdown="1">convergence</a> interactively
    and decide when to cut things off</li>
</ul>
</li>
<li>And we should find a better way to answer the question<ul>
<li>Take less time</li>
<li>Tell us how confident we can be in the answer</li>
<li>Because right now 5000 is a <a class="glossref" href="../glossary/#magic_number" markdown="1">magic number</a></li>
</ul>
</li>
</ul>
<h2>Exercises</h2>
<h3>Recording Errors</h3>
<p>Modify <code>bin/file-size.py</code> so that it creates a third file <code>-error.txt</code> with the error messages.</p>
<h3>A Two-Sided Test</h3>
<p>Modify the simulation program so that it does a two-sided test.</p>
<h3>Testing the Simulation Program</h3>
<p>Test the simulation program with more interesting datasets
(different counts, different numbers of observations, etc.).</p>
<h3>Reporting Periodically</h3>
<p>Modfiy the simulation program so that it can print results to a file periodically.</p>
<h3>Keeping All the Data</h3>
<p>How will the answer differ if we don't drop lines of length 1 and very long lines?
Why?</p>

  <hr/>
<div class="centered">
  <table class="plain footer">
    <tr>
      
      <td><a href="../license/">License</a></td>
      
      <td><a href="../conduct/">Code of Conduct</a></td>
      
      <td><a href="../bibliography/">Bibliography</a></td>
      
      <td><a href="../glossary/">Glossary</a></td>
      
      <td><a href="../links/">Links</a></td>
      
      <td><a href="https://github.com/gvwilson/buildtogether.tech.git">GitHub</a></td>
      
    </tr>
  </table>
</div>

  </body>
</html>
